<system>
  @log_level debug
</system>

<source>
  @type tail
  path "{input_act_path}/*.log"
  pos_file "{input_path}/ffxiv.pos"
  tag ffxiv.logs
  encoding utf-8
  from_encoding utf-8
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<prefix>\d+)\|(?<timestamp>[^|]+)\|(?<rest>.*)$/
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%N%:z
    keep_time_key true
  </parse>
</source>

<filter ffxiv.logs>
  @type record_transformer
  enable_ruby true
  <record>
    line ${record["prefix"]}|${record["timestamp"]}|${record["rest"]}
  </record>
</filter>

<match ffxiv.logs>
  @type loki
  @log_level debug
  url "{input_loki_url}"

  line_format key_value
  remove_keys prefix,timestamp,rest,orig_ts,job,instance,content
  extra_labels {"job":"ffxiv-dungeon","instance":"DESKTOP-LHEGLIC","content":"ffxiv"}

  <buffer>
    @type file
    path "{input_path}/buffer"
    flush_interval 5s
    retry_max_interval 1m
    chunk_limit_size 4m
  </buffer>
</match>